# Feature Dependencies

## Overview
This document maps dependencies between features to ensure correct implementation order.

---

## Dependency Graph

```
Phase 0: Foundation
â”œâ”€â”€ Supabase Auth Setup
â”œâ”€â”€ Multi-Tenant RLS
â””â”€â”€ Core Schema

Phase 1: Onboarding
â”œâ”€â”€ Niche Templates (Depends: Core Schema)
â”œâ”€â”€ Tenant Settings (Depends: Niche Templates)
â””â”€â”€ Onboarding Wizard UI (Depends: Tenant Settings)

Phase 2: Catalog
â”œâ”€â”€ Products (Depends: Niche Templates)
â”œâ”€â”€ Product Variants (Depends: Products)
â”œâ”€â”€ Unit Definitions (Depends: Product Variants)
â””â”€â”€ Product Bundles (Depends: Product Variants)

Phase 3: Inventory
â”œâ”€â”€ Locations (Depends: Core Schema)
â”œâ”€â”€ Stock Levels (Depends: Product Variants, Locations, Unit Definitions)
â”œâ”€â”€ Stock Movements (Depends: Stock Levels)
â””â”€â”€ Stock Reservations (Depends: Stock Levels, Unit Definitions)

Phase 4: Sales
â”œâ”€â”€ Orders (Depends: Stock Levels, Customers)
â”œâ”€â”€ Order Items (Depends: Orders, Product Variants)
â”œâ”€â”€ Bundle Sales (Depends: Product Bundles, Stock Levels)
â””â”€â”€ Payments (Depends: Orders)

Phase 5: Offline POS
â”œâ”€â”€ PowerSync Setup (Depends: All Core Tables)
â”œâ”€â”€ Electron Wrapper (Depends: PowerSync)
â””â”€â”€ Hardware Integration (Depends: Electron)
```

---

## Feature Dependency Matrix

| Feature | Depends On | Blocks | Status |
|---------|-----------|--------|--------|
| **Core Schema** | None | Everything | âœ… Complete |
| **RLS Policies** | Core Schema | Data Access | âœ… Complete |
| **Supabase Auth** | None | User Management | âœ… Approved |
| **Niche Templates** | Core Schema | Onboarding Wizard | âœ… Complete |
| **Tenant Settings** | Niche Templates | Product Schema | âœ… Complete |
| **Product Bundles** | Product Variants | Bundle Sales | âœ… Complete |
| **Unit Definitions** | Product Variants | Stock Levels | âœ… Complete |
| **Stock Reservations** | Stock Levels, Unit Definitions | Order Creation | âœ… Complete |
| **SaaS Governance** | Core Schema | Subscription Limits | âœ… Complete |
| **Bundle Sales Function** | Product Bundles, Stock Functions | POS | âœ… Complete |
| **Onboarding Wizard UI** | Niche Templates, Tenant Settings | First Login | ğŸ“‹ Planned |
| **PowerSync** | All Core Tables | Offline POS | ğŸ“‹ Planned |
| **Electron Wrapper** | PowerSync | Hardware Integration | ğŸ“‹ Planned |
| **ETA Integration** | Orders, Payments | Tax Compliance | ğŸ”œ Phase 3 |

---

## Critical Path

### Must Complete Before Phase 5:
1. âœ… Core Schema with all tables
2. âœ… RLS Policies with limit enforcement
3. âœ… Core Functions (adjust_stock, create_order, etc.)
4. âœ… Bundle Functions (sell_bundle)
5. âœ… SaaS Governance (subscription_plans, feature_flags)
6. âœ… Niche Templates (seed data)

### Phase 5 Prerequisites:
1. Supabase Project Creation
2. Schema Deployment (all 6 SQL files)
3. PowerSync Instance Provisioning
4. Turborepo Setup

---

## Feature-to-File Mapping

| Feature | Schema | Functions | RLS | UI | Tests |
|---------|--------|-----------|-----|----|----|
| Niche Templates | core_schema.sql | - | - | Onboarding Wizard | â³ |
| Product Bundles | core_schema.sql | bundle_functions.sql | - | Bundle Manager | â³ |
| Stock Reservations | core_schema.sql | core_functions.sql | rls_policies.sql | POS Cart | â³ |
| Subscription Limits | core_schema.sql | saas_governance.sql | rls_policies.sql | Upgrade Modal | â³ |
| Offline Sync | - | - | - | PowerSync Config | â³ |

---

## External Dependencies

### Required Services:
- **Supabase:** Database, Auth, Realtime, Storage
- **PowerSync:** Offline sync engine (requires separate instance)
- **Electron:** Desktop wrapper (npm package)

### Optional Integrations:
- **ETA API:** Egyptian Tax Authority (Phase 3)
- **Payment Gateways:** Stripe/Fawry (Phase 4)
- **WhatsApp Business API:** Notifications (Phase 4)

---

## Blocking Issues

### Current Blockers: None âœ…

### Potential Future Blockers:
1. **PowerSync Instance:** Requires provisioning before POS development
2. **Supabase Project:** Must be created before schema deployment
3. **MFA Configuration:** Requires Supabase Dashboard access

---

## Implementation Order (Recommended)

### Week 1: Infrastructure
1. Create Supabase Project
2. Deploy all SQL files
3. Configure Auth + MFA
4. Provision PowerSync instance

### Week 2: Core UI
1. Onboarding Wizard (Niche Selection)
2. Product Management (with JSONB attributes)
3. Bundle Configuration UI

### Week 3: POS
1. PowerSync integration
2. Electron wrapper
3. Hardware integration (printers, scanners)

### Week 4: Testing
1. Offline sync testing
2. Bundle sales testing
3. Subscription limit testing
4. Load testing

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-02-05 | Initial dependency map |
| 2.0 | 2026-02-09 | Added niche templates, bundles, TAGER requirements |
