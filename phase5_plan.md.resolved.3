# Phase 5: Enterprise SaaS Infrastructure (Revised)

## üìã Overview

| Item | Value |
|------|-------|
| **Objective** | Production-ready SaaS platform with offline-first POS and subscription management |
| **Duration** | 7-10 days |
| **Tech Stack** | Turborepo, Next.js 14, Supabase, PowerSync, Electron |

---

## ‚úÖ Prerequisites Checklist

Before starting Phase 5, confirm:
- [x] 22 database tables defined (core_schema.sql)
- [x] 28 RLS policies implemented (rls_policies.sql)
- [x] 12 core functions ready (core_functions.sql + bundle_functions.sql)
- [x] 3 SaaS governance functions (saas_governance.sql)
- [x] 3 niche templates seeded (seed_niche_templates.sql)
- [x] All TAGER ERP templates reviewed

---

## üèóÔ∏è Step 1: Monorepo Setup (Day 1)

### 1.1 Initialize Turborepo
```bash
npx create-turbo@latest wholesale-platform
cd wholesale-platform
```

### 1.2 Directory Structure
```
wholesale-platform/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/          # Next.js (Merchant Management)
‚îÇ   ‚îú‚îÄ‚îÄ pos/                # Next.js PWA + Electron (Hardware)
‚îÇ   ‚îî‚îÄ‚îÄ storefront/         # Next.js (B2B Portal)
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ core/               # Supabase Client, Services, PowerSync
‚îÇ   ‚îú‚îÄ‚îÄ shared/             # Types, Zod Schemas, Constants
‚îÇ   ‚îî‚îÄ‚îÄ ui/                 # Shadcn Components
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/         # SQL Schema Files
‚îÇ   ‚îî‚îÄ‚îÄ seed/               # Test Data
‚îú‚îÄ‚îÄ electron/               # POS Native Wrapper
‚îî‚îÄ‚îÄ turbo.json
```

### 1.3 Install Dependencies
```bash
# Root dependencies
pnpm add -D turbo typescript

# Core package
cd packages/core
pnpm add @supabase/supabase-js @powersync/web zod date-fns

# Shared package
cd ../shared
pnpm add zod

# UI package
cd ../ui
pnpm add @radix-ui/react-* class-variance-authority tailwindcss

# Electron
cd ../../electron
pnpm add electron electron-builder escpos
```

---

## ‚òÅÔ∏è Step 2: Supabase Configuration (Day 1-2)

### 2.1 Create Supabase Project
1. Go to [supabase.com](https://supabase.com)
2. Create new project
3. Save credentials:
   - `Project URL`
   - `anon key`
   - `service_role key`

### 2.2 Apply Migrations (ORDER MATTERS!)
```bash
supabase/migrations/
‚îú‚îÄ‚îÄ 001_core_schema.sql         # Core 22 tables
‚îú‚îÄ‚îÄ 002_seed_niche_templates.sql # 3 niche types
‚îú‚îÄ‚îÄ 003_rls_policies.sql        # 28 security policies
‚îú‚îÄ‚îÄ 004_saas_governance.sql     # Limit functions
‚îú‚îÄ‚îÄ 005_core_functions.sql      # 9 inventory/sales functions
‚îú‚îÄ‚îÄ 006_bundle_functions.sql    # sell_bundle()
‚îî‚îÄ‚îÄ 007_seed_subscription_plans.sql # Free/Silver/Gold plans
```

### 2.3 Enable MFA (Critical!)
```
Supabase Dashboard ‚Üí Authentication ‚Üí Settings:
1. Enable "Phone Auth" or "TOTP"
2. Set MFA Factor: Required for Owners
3. Configure JWT expiry: 3600 seconds
```

### 2.4 Configure JWT Claims
```sql
-- In Supabase SQL Editor, create hook:
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE auth.users SET raw_app_meta_data = 
    raw_app_meta_data || jsonb_build_object(
      'tenant_id', NEW.tenant_id,
      'role_key', NEW.role_key
    )
  WHERE id = NEW.id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_profile_created
  AFTER INSERT ON profiles
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### 2.5 Seed Subscription Plans
```sql
-- 007_seed_subscription_plans.sql
INSERT INTO subscription_plans (name, price_monthly, max_users, max_locations, max_products, features) VALUES
('Free', 0, 3, 1, 100, '{"api_access": false, "advanced_reports": false}'::JSONB),
('Silver', 499, 10, 3, 500, '{"api_access": false, "advanced_reports": true}'::JSONB),
('Gold', 999, 25, 10, 2000, '{"api_access": true, "advanced_reports": true}'::JSONB),
('Enterprise', 2499, NULL, NULL, NULL, '{"api_access": true, "advanced_reports": true, "white_label": true}'::JSONB);
```

---

## üîÑ Step 3: PowerSync Configuration (Day 2-3)

### 3.1 Provision PowerSync Instance
1. Go to [powersync.com](https://www.powersync.com)
2. Create new instance
3. Connect to Supabase

### 3.2 Define Sync Rules
```yaml
# sync-rules.yaml
bucket_definitions:
  tenant_data:
    parameters:
      - SELECT tenant_id FROM profiles WHERE id = token_parameters.user_id
    data:
      # Core data for offline POS
      - SELECT * FROM products WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM product_variants WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM unit_definitions WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM product_bundles WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM customers WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM stock_levels WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM locations WHERE tenant_id = bucket.tenant_id
      # Orders sync bidirectionally
      - SELECT * FROM orders WHERE tenant_id = bucket.tenant_id
      - SELECT * FROM order_items WHERE tenant_id = bucket.tenant_id
```

### 3.3 PowerSync Client
```typescript
// packages/core/src/sync/powersync.ts
import { PowerSyncDatabase } from '@powersync/web';

const schema = {
  products: { id: 'TEXT PRIMARY KEY', tenant_id: 'TEXT', name: 'TEXT', metadata: 'TEXT' },
  product_variants: { id: 'TEXT PRIMARY KEY', product_id: 'TEXT', sku: 'TEXT', attributes: 'TEXT' },
  product_bundles: { id: 'TEXT PRIMARY KEY', parent_variant_id: 'TEXT', child_variant_id: 'TEXT', quantity: 'REAL' },
  stock_levels: { id: 'TEXT PRIMARY KEY', variant_id: 'TEXT', location_id: 'TEXT', quantity: 'REAL' },
  orders: { id: 'TEXT PRIMARY KEY', status_key: 'TEXT', total_amount: 'REAL' },
  order_items: { id: 'TEXT PRIMARY KEY', order_id: 'TEXT', variant_id: 'TEXT', quantity: 'REAL' },
};

export const db = new PowerSyncDatabase({ schema, database: { dbFilename: 'tager.db' } });
```

---

## üñ•Ô∏è Step 4: Electron POS Wrapper (Day 3-4)

### 4.1 Electron Main Process
```javascript
// electron/main.js
const { app, BrowserWindow, ipcMain } = require('electron');
const escpos = require('escpos');
escpos.USB = require('escpos-usb');

let mainWindow;

app.whenReady().then(() => {
  mainWindow = new BrowserWindow({
    width: 1024, height: 768, kiosk: true, // Full screen for POS
    webPreferences: { nodeIntegration: true, contextIsolation: false }
  });
  mainWindow.loadURL(process.env.NODE_ENV === 'development' 
    ? 'http://localhost:3000' 
    : `file://${__dirname}/out/index.html`);
});

// Print Receipt
ipcMain.handle('print-receipt', async (event, data) => {
  const device = new escpos.USB();
  const printer = new escpos.Printer(device);
  
  device.open(() => {
    printer
      .font('a').align('ct').style('b')
      .text(data.storeName)
      .text('--------------------------------')
      .align('lt').style('normal');
    
    data.items.forEach(item => {
      printer.text(`${item.name} x${item.qty}  ${item.total}`);
    });
    
    printer
      .text('--------------------------------')
      .align('rt').style('b')
      .text(`TOTAL: ${data.total}`)
      .cut().close();
  });
});

// Open Cash Drawer
ipcMain.handle('open-drawer', async () => {
  const device = new escpos.USB();
  device.open(() => {
    device.write(Buffer.from([0x1B, 0x70, 0x00, 0x19, 0xFA]));
    device.close();
  });
});
```

### 4.2 Hardware Service (Renderer)
```typescript
// apps/pos/src/lib/hardware.ts
export const hardware = {
  async printReceipt(order: Order) {
    if (window.electron) {
      await window.electron.ipcRenderer.invoke('print-receipt', {
        storeName: 'TAGER Store',
        items: order.items.map(i => ({ name: i.name, qty: i.quantity, total: i.total_price })),
        total: order.total_amount
      });
    }
  },
  
  async openCashDrawer() {
    if (window.electron) {
      await window.electron.ipcRenderer.invoke('open-drawer');
    }
  }
};
```

---

## üßô Step 5: Onboarding Wizard (Day 4-5)

### 5.1 API Routes
```typescript
// apps/dashboard/src/app/api/niches/route.ts
export async function GET() {
  const { data } = await supabase
    .from('niche_templates')
    .select('*')
    .eq('is_active', true);
  return Response.json(data);
}

// apps/dashboard/src/app/api/tenant/settings/route.ts
export async function POST(req: Request) {
  const { niche_type } = await req.json();
  const tenantId = await getTenantId();
  
  await supabase.from('tenant_settings').upsert({
    tenant_id: tenantId,
    niche_type,
    onboarding_completed: true
  });
  
  return Response.json({ success: true });
}
```

### 5.2 Wizard UI Component
```tsx
// apps/dashboard/src/components/OnboardingWizard.tsx
'use client';
import { useState } from 'react';

const niches = [
  { type: 'clothing', name: 'Clothing & Fashion', icon: 'üëï' },
  { type: 'auto_parts', name: 'Auto Parts', icon: 'üöó' },
  { type: 'fmcg', name: 'FMCG & Food', icon: 'üçé' },
];

export function OnboardingWizard() {
  const [selected, setSelected] = useState<string | null>(null);
  
  const handleComplete = async () => {
    await fetch('/api/tenant/settings', {
      method: 'POST',
      body: JSON.stringify({ niche_type: selected })
    });
    window.location.href = '/dashboard';
  };
  
  return (
    <div className="grid grid-cols-3 gap-4">
      {niches.map(niche => (
        <button
          key={niche.type}
          onClick={() => setSelected(niche.type)}
          className={`p-6 rounded-lg border-2 ${selected === niche.type ? 'border-blue-500' : 'border-gray-200'}`}
        >
          <span className="text-4xl">{niche.icon}</span>
          <h3>{niche.name}</h3>
        </button>
      ))}
      <button onClick={handleComplete} disabled={!selected}>
        Complete Setup
      </button>
    </div>
  );
}
```

---

## üì¶ Step 6: Bundle Management UI (Day 5-6)

### 6.1 Bundle Configuration
```tsx
// apps/dashboard/src/components/BundleBuilder.tsx
export function BundleBuilder({ parentVariantId }: { parentVariantId: string }) {
  const [children, setChildren] = useState<{ variantId: string; quantity: number }[]>([]);
  
  const addChild = (variantId: string, quantity: number) => {
    setChildren([...children, { variantId, quantity }]);
  };
  
  const saveBundle = async () => {
    for (const child of children) {
      await supabase.from('product_bundles').insert({
        tenant_id: tenantId,
        parent_variant_id: parentVariantId,
        child_variant_id: child.variantId,
        quantity: child.quantity
      });
    }
  };
  
  return (
    <div>
      <h2>Configure Bundle</h2>
      {/* Variant selector + quantity input */}
      <button onClick={saveBundle}>Save Bundle</button>
    </div>
  );
}
```

---

## üíº Step 7: SaaS Governance (Day 6)

### 7.1 Subscription Service
```typescript
// packages/core/src/services/subscriptions.ts
export const subscriptionService = {
  async getActivePlan(tenantId: string) {
    const { data } = await supabase
      .from('tenant_subscriptions')
      .select('*, subscription_plans(*)')
      .eq('tenant_id', tenantId)
      .eq('status', 'active')
      .single();
    return data;
  },
  
  async checkLimit(tenantId: string, limitKey: 'max_users' | 'max_locations' | 'max_products') {
    const { data } = await supabase.rpc('get_tenant_limit', {
      p_tenant_id: tenantId,
      p_limit_key: limitKey
    });
    return data;
  },
  
  async hasFeature(tenantId: string, featureKey: string) {
    const { data } = await supabase.rpc('has_feature_access', {
      p_tenant_id: tenantId,
      p_feature_key: featureKey
    });
    return data;
  }
};
```

### 7.2 Upgrade Prompt Component
```tsx
// packages/ui/src/components/UpgradePrompt.tsx
export function UpgradePrompt({ feature }: { feature: string }) {
  return (
    <div className="bg-yellow-50 p-4 rounded-lg">
      <h3>Upgrade Required</h3>
      <p>The "{feature}" feature requires a higher plan.</p>
      <button>View Plans</button>
    </div>
  );
}
```

---

## üß™ Step 8: Testing (Day 7-8)

### 8.1 RLS Isolation Test
```sql
-- Test 1: User A cannot see User B data
SET LOCAL request.jwt.claims = '{"app_metadata": {"tenant_id": "tenant-a"}}';
SELECT * FROM products; -- Should only return tenant-a products

SET LOCAL request.jwt.claims = '{"app_metadata": {"tenant_id": "tenant-b"}}';
SELECT * FROM products; -- Should only return tenant-b products
```

### 8.2 Subscription Limit Test
```sql
-- Set tenant to Free plan (max 3 users)
INSERT INTO tenant_subscriptions (tenant_id, plan_id, status, starts_at)
VALUES ('test-tenant', (SELECT id FROM subscription_plans WHERE name = 'Free'), 'active', NOW());

-- Try to create 4th user (should fail)
INSERT INTO profiles (id, tenant_id, full_name, role_key)
VALUES (gen_random_uuid(), 'test-tenant', 'User 4', 'cashier');
-- Expected: ERROR: Subscription limit exceeded
```

### 8.3 Bundle Sales Test
```sql
-- Create bundle: Mixed Set = 2 Large + 3 Small
INSERT INTO product_bundles (tenant_id, parent_variant_id, child_variant_id, quantity)
VALUES 
  ('test-tenant', 'parent-id', 'large-id', 2),
  ('test-tenant', 'parent-id', 'small-id', 3);

-- Sell 1 bundle
SELECT sell_bundle('test-tenant', 'parent-id', 'location-id', 1, 'order-id');

-- Verify stock deducted:
-- Large: -2, Small: -3
SELECT * FROM stock_movements WHERE reference_id = 'order-id';
```

### 8.4 Offline Sync Test
```typescript
// 1. Disconnect
await db.disconnectAndClear();

// 2. Create order offline
await db.execute('INSERT INTO orders (id, tenant_id, total_amount, status_key) VALUES (?, ?, ?, ?)', 
  [uuid(), tenantId, 100, 'pending']);

// 3. Reconnect
await db.connect({ powerSyncUrl, token });
await db.waitForReady();

// 4. Verify synced
const { data } = await supabase.from('orders').select('*').eq('id', orderId);
expect(data.length).toBe(1);
```

---

## ‚úÖ Final Checklist

### Infrastructure
- [ ] Turborepo initialized
- [ ] Supabase project created
- [ ] All 6 migration files applied
- [ ] Subscription plans seeded
- [ ] MFA enabled for owners
- [ ] JWT claims hook configured

### PowerSync
- [ ] Instance provisioned
- [ ] Sync rules deployed
- [ ] Client configured

### Electron POS
- [ ] Main process ready
- [ ] Printer integration tested
- [ ] Cash drawer tested
- [ ] Barcode scanner working

### UI Components
- [ ] Onboarding Wizard complete
- [ ] Bundle Builder complete
- [ ] Upgrade Prompt component
- [ ] Dashboard layout

### Testing
- [ ] RLS isolation verified
- [ ] Subscription limits enforced
- [ ] Bundle sales working
- [ ] Offline sync verified
- [ ] MFA flow tested

---

## üìä Success Metrics (TAGER ERP KPIs)

| Metric | Target | Measurement |
|--------|--------|-------------|
| POS Transaction Speed | < 2 seconds | Time from scan to receipt |
| Sync Conflict Rate | < 0.1% | PowerSync analytics |
| Onboarding Completion | > 80% | Wizard funnel |
| Offline Uptime | 100% | POS works without internet |
